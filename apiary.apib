FORMAT: 1A
HOST: https://res.uzhenbao.com/v3

# 优真宝数据接口v3

优真宝移动端数据接口

# 文档说明

本文档使用 `RESTful` 风格 API, 当前处于更新期, 在使用过程中如有错误, 及时反馈

# 网络协议

Api使用 `Https` h2协议, 默认端口443

```
https://res.uzhenbao.com/v3
```

# 版本及特性

API 当前版本 `3`,  新版将较之前的版本作更加规范的数据格式及返回消息, 修正前两个版本语义不当的地方

# 请求动作

RESTful API使用如下动词, 完成客户端与服务器间的交互操作

| Method | Description |
|---|---|
| `GET` | 获取单个或列表资源, 正常时返回 `200`, 未找到时返回 `404` |
| `POST` | 创建资源, 正常时返回 `201` |
| `PUT` | 更新一个资源, 成功时返回 `200`|
| `DELETE` | 删除资源, 成功时 `204`|


# HTTP状态码

HTTP状态码是客户端接收服务器响应状态, 根据不同的状态提示用户或处理逻辑, 在接收数据前应首先判断状态码

| Code | Description |
|---|---|
| `200` | Success - *正常或已更新(GET, PUT)*
| `201` | Success - *资源被创建 (POST)*
| `204` | Success - *无返回内容 (DELETE)*
| `400` | Bad Request - *请求验证不通过, 参数有误*
| `401` | Unauthorized - *需要登录验证, 未验证的*
| `403` | Forbidden - *访问被拒绝*
| `404` | Not Found - *资源不存在*
| `405` | Method Not Found - *方法不存在*
| `409` | Conflict - *资源已存在*
| `410` | Gone - *资源已失效, 过期*|
| `412` | Precondition Failed - *不满足请求条件*
| `422` | Unprocessible Entity - *验证错误*
| `429` | Too Many Requests - *请求频繁, 稍后重试*
| `500` | Server Error - *服务器内部错误*
| `503` | Service Unavailable - *服务器繁忙 (30秒内重新尝试请求)*
| `504` | Service Timeout - *请求超时 (30秒内重新尝试请求)*


# 业务状态码

业务状态码会在请求异常时以`application/json`方式返回给客户端, 字段名为`code`, 通常会附带一条`message`和`data`, 部分业务还会添加其它扩展字段，会在相应的请求说明，`request`将返回客户端请求的具体数据，方便开发者进行调试

业务码解释 1 - 2 - 3
* 1 为 http 状态码
* 2 为模块代码
* 3 为业务细分代码

例： 4041303
解释： 未找到用户模块的地址


Response 参数说明

|Name|Data Type|Description|
|---|---|---|
|status|int|同http状态码|
|code|int|业务状态码|
|message|string|业务消息|
|data|object|与该业务有关的数据|
|request|object|客户端请求数据|

Response 异常示例:
```
{
  "status": 404,
  "code": 4040201,
  "message": "product not found",
  "data": {
    "product_id": "565"
  },
  "request": {
    "url": "https://dev-res.uzhenbao.com/v3/orders/products/preview",
    "method": "POST",
    "data": {
      "items": [
        {
          "amount": "1",
          "product_id": "565",
          "product_item_id": "1037",
          "car_id": "77"
        },
        {
          "amount": "1",
          "product_id": "565",
          "product_item_id": "1038",
          "car_id": "97"
        }
      ],
      "shipping_address_id": "254",
      "is_invoice": "0"
    }
  }
}
```

# 数据类型

接口只返回`Application/json`格式数据, 请不要尝试在`Headers`中使用`Accept`来声明接收的意向数据类型


# 验证

*注意: 以下3种验证结果为全局验证，将不再在具体的接口中描述*

## 1.客户端验证

为了api接口安全,需要接口进行签名验证, 每条请求需要在`Headers`中添加如下参数

| Name | Type | Value | Description |
|---|---|---|---|
|`app-key`| string |`9sk82lsSlw9IKM` |由系统分配, 应用栏目获取 |
|`timestamp`| int |`1478333136` | unix 时间辍, 单位秒 |
|`sign`| string |`60ce041f972501bf2be046fc6d7f5617f8677264` | sha1 混淆获取 |

`sign` 算法: `sha1(httpMethod+apiUrl+timestamp+contentLength+appSecret)`, 注意顺序一致

算法参数说明

| Name | Type | Value | Description |
|---|---|---|---|
|`httpMethod`| string |`GET|POST|PUT|DELETE`| 大写|
|`apiUrl`| string |`https://res.uzhenbao.com/v3/products`| 如有`?|&`参数, 需携带|
|`timestamp`| string |`1478333136` |unix 时间辍, 单位秒, 注意要与header中的`timestamp`值一致|
|`contentLength`| int | `0` | 请求体总长度|
|`appSecret`| string |`ksi28Skxmsw01lZs391` | 由系统分配, 固定, 管理平台`应用`栏目获取, 签名密钥, 不可暴露, 移动端应放在安全的位置,或做包混淆|

验证错误会返回如下几种结果:

```
{
  "status": 504,
  "code": 5040101,
  "message": "not sync timeout",
  "data": null,
  "server_timestamp": 1494297455,
}

```

> 问题原因是客户端与服务器时间不同步导致, 返回的`server_timestamp`为服务器当前时间, 移动端应计算时差以保证时间同步,
后再次重试请求, 如请求失败最多尝试5次, 均失败后停止请求并告知用户: 稍后重试

```
{
  "status": 401,
  "code": 4012502,
  "message": "sign unauthorized",
  "data": null
}
```

> 签名错误, 请确认参数及顺序正确, 核对sha1方法是否有差异


```
{
  "status": 409,
  "code": 4090003,
  "message": "request repeat",
  "data": null
}
```

> 同一时间内避免重复提交相同内容, 间隔时间为1秒

```
{
  "status": 404,
  "code": 4042502,
  "message": "app key not found",
  "data": null
}
```

> app key 不存在，检查移动app key是否正确


## 2.请求参数验证

为了保证客户端输入的数据为有效数据，服务器将验证每个接口所需要的特定的参数所支持的数据类型及数据长度等信息

验证错误会返回与当前请求相关的错误信息

```
{
  "status": 400,
  "code": 4000001,
  "message": "params error",
  "data": {
    "items": [
      "The items field is required."
    ]
  },
  "request": {
    "url": "https://dev-res.uzhenbao.com/v3/orders/products/preview",
    "method": "POST",
    "data": []
  }
}
```

> 检查对应接口的参数是否按要求包含的请求体中


## 3.用户身份验证

需要验证用户身份地方使用`Token`机制验证用户身份, 用户请求接口中使用`Headers`将`user-id`和`access-token`提交给服务器验证

例：

```
{
    user-id: 1,
    access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux
}
```

| Name | Value | Description |
|---|---|---|
|`user-id`| `22` | 用户id |
|`access-token`| `$2y$10$Kbz6jSCLHLkm4D5Gp67xhux` | 用户访问token |


验证错误将会返回如下结果：

```
{
  "status": 401,
  "code": 4011301,
  "message": "user unauthorized",
  "data": null
}
```

> 用户验证失败, token或已过期, 应执行重新登录操作


# H5单页

以下页面在合适的位置添加链接或加载至webview

| Description | Url |
|---|---|
| 平台服务协议 | `https://m.uzhenbao.com/users/agreement` |
| 商品售后服务协议 | `https://m.uzhenbao.com/goodsReturns/agreement` |
| 销售者说明 | `https://m.uzhenbao.com/orderResults/agreement` |
| 找回密码 | `https://m.uzhenbao.com/findPassword` |
| 应用官网 | `https://app.uzhenbao.com` |




# group 用户

## 设置 [/userSettings/autoReply]

### 显示自动回复内容 [GET /userSettings/autoReply]

+ Request

    + Headers

            timestamp: 1478840722
            app-key: 92lsk20ks
            sign: 9cf1587dac6bef69d34eaaec467689a7ffe2a5d5
            user-id: 2300
            access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux

+ Response 200 (application/json)


            {
              "user_id": 2300,
              "is_message_auto_reply": 1,
              "auto_reply_content": "你好我现在不在",
              "created_at": "2017-05-09 13:22:49",
              "updated_at": "2017-05-09 13:23:53"
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040001,
              "message": "not found",
              "data": null,
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/userSettings/autoReply",
                "method": "GET",
                "data": []
              }
            }

### 设置并打开自动回复 [POST /userSettings/autoReply/open]


Request 参数

| Name | Type | Length | Value | Description |
|---|---|---|---|---|
|`auto_reply_content`|string|(0,255]|你好，我现在有事不在，稍后联系你|设置自动回复的消息|

+ Request

    + Headers

            timestamp: 1478840722
            app-key: 92lsk20ks
            sign: 9cf1587dac6bef69d34eaaec467689a7ffe2a5d5
            user-id: 2300
            access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux

    + Attributes

        + auto_reply_content: 你好，我现在有事不在，稍后联系你 (required) - 回复内容

+ Response 201 (application/json)

            {
              "user_id": 2300,
              "updated_at": "2017-05-09 16:03:27",
              "created_at": "2017-05-09 16:03:27",
              "auto_reply_content": "你好我现在不在",
              "is_message_auto_reply": 1
            }

### 关闭自动回复 [PUT /userSettings/autoReply/close]


+ Request

    + Headers

            timestamp: 1478840722
            app-key: 92lsk20ks
            sign: 9cf1587dac6bef69d34eaaec467689a7ffe2a5d5
            user-id: 2300
            access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux


+ Response 200 (application/json)

            {
              "user_id": 2300,
              "is_message_auto_reply": 0,
              "auto_reply_content": "你好我现在不在",
              "created_at": "2017-05-09 16:03:27",
              "updated_at": "2017-05-09 16:11:29"
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040001,
              "message": "not found",
              "data": null,
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/userSettings/autoReply",
                "method": "GET",
                "data": []
              }
            }


# group 订单

## 平台商品 [/orders/product]

### 预览订单 [POST /orders/product/preview]

生成订单前使用此接口确认库存, 优惠及价格信息, 是否可使用优惠券等

Request 参数

|Name|Type|Reqruied|Value|Length|Description|
|---|---|---|---|---|---|
|`items`|array|required||N|商品数组|
|`items.*`|object|required||N|对象|
|`items.*.product_id`|int|required|2|N|商品id|
|`items.*.product_item_id`|int|required|23|N|商品sku id|
|`items.*.amount`|int|required|1|[1,99]|该商品购买数量|
|`items.*.car_id`|int|optional|3|N|购物车id, 生成订单后将删除对应的购物车内商品|
|`shipping_address_id`|int|optional|12|N|用户收货地址id|
|`is_invoice`|int|optional|1|N|`1|0` 开具发票, 1 需要, 0 不需要|
|`coupon_id`|int|optional|2|N|优惠券id|
|`memo`|string|optional|尽早发货|[0, 255]|备注内容|

+ Request

    + Headers

            timestamp: 1478840722
            app-key: 92lsk20ks
            sign: 9cf1587dac6bef69d34eaaec467689a7ffe2a5d5
            user-id: 2300
            access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux

    + Attributes

        + items (array, required)
            + (object)
                + product_id: 2 (required) - id of a product
                + product_item_id: 23 (required) - id of a product sku
                + amount: 1 (required) - number
                + car_id: 2 (optional) - shopping car id
            + (object)
                + product_id: 2 (required) - id of a product
                + product_item_id: 23 (required) - id of a product sku
                + amount: 1 (required) - number
                + car_id: 3 (optional) - shopping car id
        + shipping_address_id: 4 (optional) - 收货地址id
        + is_invoice: 0 (optional, number) - 默认0 不开具发票, 1 开发票
        + coupon_id: 1 (optional, number) - 优惠券id
        + memo: 这是备注内容 (optional, string) - 备注内容, 最多255字

+ Response 200 (application/json)

            {
              "total_price": 2,
              "original_price": 2,
              "postage": 0,
              "coupon_price": 0,
              "available_coupons": [
                {
                  "id": 16,
                  "coupon_id": 43,
                  "coupon_code_id": 93,
                  "user_id": 2300,
                  "created_at": "2017-03-28 18:45:06",
                  "updated_at": "2017-05-04 14:35:01",
                  "is_used": 0,
                  "expired_at": "2017-07-30 00:00:00",
                  "coupon": {
                    "id": 43,
                    "name": "111",
                    "amount": 111,
                    "allowance": 108,
                    "cash": "11.00",
                    "overflow_price": "0.00",
                    "created_at": "2017-03-28 17:06:26",
                    "updated_at": "2017-05-04 16:08:04",
                    "expired_at": "2017-07-30 00:00:00",
                    "deleted_at": null,
                    "issue_id": 1,
                    "start_at": "2017-02-28 00:00:00",
                    "end_at": "2017-07-28 00:00:00",
                    "category_id": 0,
                    "category": null
                  }
                }
              ]
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040201,
              "message": "product not found",
              "data": {
                "product_id": "565"
              },
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0"
                }
              }
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040202,
              "message": "product item not found",
              "data": {
                "product_item_id": "10371"
              },
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "1",
                      "product_id": "564",
                      "product_item_id": "10371",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0"
                }
              }
            }


+ Response 403 (application/json)

            {
              "status": 403,
              "code": 4033101,
              "message": "coupon not available",
              "data": null,
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "99",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0",
                  "coupon_id": "19"
                }
              }
            }



### 生成订单 [POST /orders/product]


Request 参数

|Name|Type|Reqruied|Value|Length|Description|
|---|---|---|---|---|---|
|`items`|array|required||N|商品数组|
|`items.*`|object|required||N|对象|
|`items.*.product_id`|int|required|2|N|商品id|
|`items.*.product_item_id`|int|required|23|N|商品sku id|
|`items.*.amount`|int|required|1|[1,99]|该商品购买数量|
|`items.*.car_id`|int|optional|3|N|购物车id, 生成订单后将删除对应的购物车内商品|
|`shipping_address_id`|int|required|12|N|用户收货地址id|
|`is_invoice`|int|optional|1|N|`1|0` 开具发票, 1 需要, 0 不需要|
|`coupon_id`|int|optional|2|N|优惠券id|
|`memo`|string|optional|尽早发货|[0, 255]|备注内容|


+ Request

    + Headers

            timestamp: 1478840722
            app-key: 92lsk20ks
            sign: 9cf1587dac6bef69d34eaaec467689a7ffe2a5d5
            user-id: 2300
            access-token: $2y$10$Kbz6jSCLHLkm4D5Gp67xhux

    + Attributes

        + items (array, required)
            + (object)
                + product_id: 2 (required) - id of a product
                + product_item_id: 23 (required) - id of a product sku
                + amount: 1 (required) - number
                + car_id: 2 (optional) - shopping car id
            + (object)
                + product_id: 2 (required) - id of a product
                + product_item_id: 23 (required) - id of a product sku
                + amount: 1 (required) - number
                + car_id: 3 (optional) - shopping car id
        + shipping_address_id: 4 (required) - 收货地址id
        + is_invoice: 0 (optional, number) - 默认0 不开具发票, 1 开发票
        + coupon_id: 1 (optional, number) - 优惠券id
        + memo: 这是备注内容 (optional, string) - 备注内容, 最多255字


+ Response 201 (application/json)

            {
              "id": 197,
              "order_no": "17050917482623000808",
              "status": "0",
              "user_id": 2300,
              "return_id": null,
              "amount": 0,
              "original_price": "0.04",
              "total_price": "0.04",
              "coupon_price": "11.00",
              "memo": null,
              "created_at": "2017-05-09 17:48:39",
              "updated_at": "2017-05-09 17:48:39",
              "deleted_at": null,
              "cancel_id": null,
              "cancel_description": null,
              "pay_platform_id": null,
              "pay_platform_trade_no": null,
              "coupon_id": 16,
              "coupon_group_id": 43,
              "is_invoice": 0,
              "invoice_type": null,
              "invoiced": null,
              "express_id": null,
              "tracking_number": null,
              "express_traces": null,
              "express_refresh": "2017-05-09 17:48:39",
              "dispatched_at": null,
              "received_at": null,
              "is_refunded": null,
              "is_restored_stock": 0,
              "seller_id": null,
              "buyer_id": null,
              "type": 0,
              "order_state": null
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040201,
              "message": "product not found",
              "data": {
                "product_id": "565"
              },
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0"
                }
              }
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4040202,
              "message": "product item not found",
              "data": {
                "product_item_id": "10371"
              },
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "1",
                      "product_id": "564",
                      "product_item_id": "10371",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0"
                }
              }
            }

+ Response 404 (application/json)

            {
              "status": 404,
              "code": 4041303,
              "message": "address not found",
              "data": null,
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254555",
                  "coupon_id": "16",
                  "is_invoice": "0"
                }
              }
            }

+ Response 403 (application/json)

            {
              "status": 403,
              "code": 4033101,
              "message": "coupon not available",
              "data": null,
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product/preview",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "99",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0",
                  "coupon_id": "19"
                }
              }
            }

+ Response 403 (application/json)

            {
              "status": 403,
              "code": 4030202,
              "message": "product item under stocks",
              "data": {
                "product_item_id": "1037"
              },
              "request": {
                "url": "https://dev-res.uzhenbao.com/v3/orders/product",
                "method": "POST",
                "data": {
                  "items": [
                    {
                      "amount": "99",
                      "product_id": "565",
                      "product_item_id": "1037",
                      "car_id": "77"
                    },
                    {
                      "amount": "1",
                      "product_id": "565",
                      "product_item_id": "1038",
                      "car_id": "97"
                    }
                  ],
                  "shipping_address_id": "254",
                  "is_invoice": "0"
                }
              }
            }